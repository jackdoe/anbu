<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ANBU: Python Coding Challenges</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/matifandy8/NeoBrutalismCSS@main/NeoBrutalismCSS.css">
  <link href="https://fonts.googleapis.com/css2?family=Lexend+Mega:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Lexend Mega', sans-serif;
      background: #ffd700;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .header {
      background: #4a90e2;
      border-bottom: 5px solid #000;
      padding: 15px 20px;
      box-shadow: 0 5px 0 #000;
    }

    .header h1 {
      font-size: 1.3rem;
      color: #000;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .header-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .challenge-nav {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .nav-btn {
      width: 50px;
      height: 50px;
      background: #fff;
      border: 4px solid #000;
      cursor: pointer;
      font-size: 20px;
      font-weight: bold;
      box-shadow: 4px 4px 0 #000;
      transition: all 0.1s;
    }

    .nav-btn:hover:not(:disabled) {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 #000;
    }

    .nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .challenge-counter {
      background: #fff;
      border: 4px solid #000;
      padding: 10px 20px;
      font-weight: bold;
      box-shadow: 4px 4px 0 #000;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
    }

    .mobile-action-buttons {
      display: none;
    }

    .btn {
      padding: 12px 24px;
      font-family: 'Lexend Mega', sans-serif;
      font-weight: bold;
      font-size: 14px;
      border: 4px solid #000;
      cursor: pointer;
      text-transform: uppercase;
      box-shadow: 5px 5px 0 #000;
      transition: all 0.1s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover:not(:disabled) {
      transform: translate(2px, 2px);
      box-shadow: 3px 3px 0 #000;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-reset {
      background: #fff;
      color: #000;
    }

    .btn-submit {
      background: #4ecdc4;
      color: #000;
    }

    .btn-games {
      background: #ff6b35;
      color: #000;
    }

    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .sidebar {
      width: 380px;
      background: #f7f7f7;
      border-right: 5px solid #000;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 5px 0 0 #000;
    }

    .sidebar h2 {
      font-size: 1.5rem;
      margin-bottom: 10px;
      color: #000;
    }

    .description {
      background: #fff;
      border: 4px solid #000;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 4px 4px 0 #000;
    }

    .test-cases h3 {
      margin-bottom: 15px;
      font-size: 1.1rem;
    }

    .test-case {
      background: #fff;
      border: 4px solid #000;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 3px 3px 0 #000;
      font-size: 0.85rem;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .test-case code {
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: pre-wrap;
      display: inline-block;
      max-width: 100%;
    }

    .test-input {
      color: #ff6b35;
      font-weight: bold;
    }

    .test-expected {
      color: #4ecdc4;
      font-weight: bold;
    }

    .loading-indicator {
      background: #ffd700;
      border: 4px solid #000;
      padding: 12px;
      margin-top: 15px;
      box-shadow: 3px 3px 0 #000;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .editor-section {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .editor-tab {
      background: #ff6b35;
      border-bottom: 4px solid #000;
      padding: 10px 20px;
      font-weight: bold;
      color: #000;
    }

    #editor {
      flex: 1;
      border-right: 5px solid #000;
    }

    .output-section {
      height: 300px;
      background: #1e1e1e;
      border-top: 5px solid #000;
      overflow-y: auto;
      box-shadow: 0 -5px 0 #000;
    }

    .output-header {
      background: #4ecdc4;
      border-bottom: 4px solid #000;
      padding: 12px 20px;
      font-weight: bold;
      color: #000;
      text-transform: uppercase;
    }

    .output-content {
      padding: 20px;
      color: #fff;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      white-space: pre-wrap;
    }

    .test-results {
      padding: 20px;
    }

    .test-result {
      background: #fff;
      border: 4px solid #000;
      padding: 15px;
      margin-bottom: 12px;
      box-shadow: 4px 4px 0 #000;
    }

    .test-result.passed {
      background: #4ecdc4;
    }

    .test-result.failed {
      background: #ff6b35;
    }

    .test-result-title {
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 1rem;
    }

    .test-result-details {
      font-size: 0.85rem;
      line-height: 1.6;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .test-result-details div {
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    /* Games Modal Styles */
    .games-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .games-container {
      background: #ffd700;
      border: 5px solid #000;
      box-shadow: 10px 10px 0 #000;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 20px;
    }

    .games-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 4px solid #000;
    }

    .games-header h2 {
      font-size: 1.8rem;
      margin: 0;
    }

    .close-btn {
      width: 50px;
      height: 50px;
      background: #ff6b35;
      border: 4px solid #000;
      cursor: pointer;
      font-size: 24px;
      font-weight: bold;
      box-shadow: 4px 4px 0 #000;
      transition: all 0.1s;
    }

    .close-btn:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 #000;
    }

    .games-menu {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .game-btn {
      background: #fff;
      border: 4px solid #000;
      padding: 30px;
      cursor: pointer;
      box-shadow: 6px 6px 0 #000;
      transition: all 0.1s;
      font-family: 'Lexend Mega', sans-serif;
    }

    .game-btn:hover {
      transform: translate(3px, 3px);
      box-shadow: 3px 3px 0 #000;
    }

    .game-icon {
      font-size: 4rem;
      margin-bottom: 10px;
    }

    .game-name {
      font-size: 1.2rem;
      font-weight: bold;
      color: #000;
    }

    .game-area {
      text-align: center;
    }

    .game-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background: #fff;
      border: 4px solid #000;
      box-shadow: 4px 4px 0 #000;
    }

    .btn-back {
      background: #fff;
      color: #000;
      padding: 10px 20px;
    }

    #gameScore {
      font-size: 1.2rem;
      font-weight: bold;
    }

    #gameCanvas {
      background: #fff;
      border: 4px solid #000;
      box-shadow: 6px 6px 0 #000;
      display: block;
      margin: 0 auto 20px;
    }

    #gameInstructions {
      background: #4ecdc4;
      border: 4px solid #000;
      padding: 15px;
      box-shadow: 4px 4px 0 #000;
      margin-top: 15px;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .mobile-game-controls {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .control-row {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .control-btn {
      width: 60px;
      height: 60px;
      background: #4a90e2;
      border: 4px solid #000;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 4px 4px 0 #000;
      transition: all 0.1s;
      font-weight: bold;
    }

    .control-btn:active {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 #000;
    }

    @media (min-width: 769px) {
      .mobile-game-controls {
        display: none !important;
      }
    }

    @media (max-width: 1024px) {
      .sidebar {
        width: 320px;
      }

      .header h1 {
        font-size: 1.5rem;
      }
    }

    @media (max-width: 768px) {
      body {
        overflow: auto;
      }

      .container {
        height: auto;
        min-height: 100vh;
      }

      .header {
        padding: 12px 15px;
      }

      .header h1 {
        font-size: 1rem;
        margin-bottom: 8px;
      }

      .header-controls {
        flex-direction: column;
        gap: 10px;
      }

      .challenge-nav {
        width: 100%;
        justify-content: center;
      }

      .nav-btn {
        width: 45px;
        height: 45px;
        font-size: 18px;
      }

      .challenge-counter {
        padding: 8px 16px;
        font-size: 0.85rem;
      }

      .action-buttons {
        display: none;
      }

      .mobile-action-buttons {
        display: flex;
        gap: 10px;
        padding: 15px 20px;
        background: #f7f7f7;
        border-bottom: 5px solid #000;
        box-shadow: 0 5px 0 #000;
      }

      .mobile-action-buttons .btn {
        padding: 12px 24px;
        font-size: 13px;
        flex: 1;
      }

      .main-content {
        flex-direction: column;
        overflow: visible;
      }

      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 5px solid #000;
        box-shadow: 0 5px 0 #000;
        height: auto;
        overflow-y: visible;
      }

      .sidebar h2 {
        font-size: 1.2rem;
      }

      .description {
        font-size: 0.9rem;
      }

      .test-cases h3 {
        font-size: 1rem;
      }

      .test-case {
        font-size: 0.8rem;
        padding: 10px;
      }

      .editor-section {
        min-height: 300px;
      }

      .editor-tab {
        padding: 8px 15px;
        font-size: 0.9rem;
      }

      #editor {
        border-right: none;
        min-height: 300px;
      }

      .output-section {
        height: auto;
        min-height: 200px;
      }

      .output-header {
        padding: 10px 15px;
        font-size: 0.9rem;
      }

      .output-content {
        padding: 15px;
        font-size: 13px;
      }

      .test-results {
        padding: 15px;
      }

      .test-result {
        padding: 12px;
        margin-bottom: 10px;
      }

      .test-result-title {
        font-size: 0.9rem;
      }

      .test-result-details {
        font-size: 0.8rem;
      }
    }

    @media (max-width: 480px) {
      .header {
        padding: 10px;
      }

      .header h1 {
        font-size: 0.85rem;
        letter-spacing: 1px;
      }

      .nav-btn {
        width: 40px;
        height: 40px;
        font-size: 16px;
        border: 3px solid #000;
        box-shadow: 3px 3px 0 #000;
      }

      .challenge-counter {
        padding: 6px 12px;
        font-size: 0.75rem;
        border: 3px solid #000;
        box-shadow: 3px 3px 0 #000;
      }

      .mobile-action-buttons {
        padding: 12px 15px;
        border-bottom: 4px solid #000;
        box-shadow: 0 4px 0 #000;
      }

      .mobile-action-buttons .btn {
        padding: 10px 18px;
        font-size: 12px;
        border: 3px solid #000;
        box-shadow: 4px 4px 0 #000;
      }

      .sidebar {
        padding: 15px;
      }

      .sidebar h2 {
        font-size: 1rem;
      }

      .description {
        font-size: 0.85rem;
        padding: 12px;
        border: 3px solid #000;
        box-shadow: 3px 3px 0 #000;
      }

      .test-cases h3 {
        font-size: 0.9rem;
      }

      .test-case {
        font-size: 0.75rem;
        padding: 8px;
        border: 3px solid #000;
        box-shadow: 2px 2px 0 #000;
      }

      .editor-tab {
        padding: 6px 12px;
        font-size: 0.85rem;
      }

      #editor {
        min-height: 250px;
      }

      .output-content {
        padding: 12px;
        font-size: 12px;
      }

      .test-result {
        padding: 10px;
        border: 3px solid #000;
        box-shadow: 3px 3px 0 #000;
      }

      .test-result-title {
        font-size: 0.85rem;
      }

      .test-result-details {
        font-size: 0.75rem;
      }

      .loading-indicator {
        font-size: 0.8rem;
        padding: 10px;
        border: 3px solid #000;
        box-shadow: 2px 2px 0 #000;
      }

      .games-modal {
        padding: 10px;
      }

      .games-container {
        padding: 15px;
        max-height: 95vh;
        border: 4px solid #000;
        box-shadow: 6px 6px 0 #000;
      }

      .games-header h2 {
        font-size: 1.2rem;
      }

      .close-btn {
        width: 40px;
        height: 40px;
        font-size: 20px;
        border: 3px solid #000;
        box-shadow: 3px 3px 0 #000;
      }

      .games-menu {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .game-btn {
        padding: 20px;
        border: 3px solid #000;
        box-shadow: 4px 4px 0 #000;
      }

      .game-icon {
        font-size: 3rem;
      }

      .game-name {
        font-size: 1rem;
      }

      .game-controls {
        flex-direction: column;
        gap: 10px;
        padding: 12px;
        border: 3px solid #000;
        box-shadow: 3px 3px 0 #000;
      }

      .btn-back {
        align-self: flex-start;
      }

      #gameScore {
        font-size: 1rem;
      }

      #gameCanvas {
        max-width: 100%;
        border: 3px solid #000;
        box-shadow: 4px 4px 0 #000;
      }

      #gameInstructions {
        font-size: 0.8rem;
        padding: 12px;
        border: 3px solid #000;
        box-shadow: 3px 3px 0 #000;
      }

      .control-btn {
        width: 55px;
        height: 55px;
        font-size: 20px;
        border: 3px solid #000;
        box-shadow: 3px 3px 0 #000;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-controls">
        <div class="challenge-nav">
          <button class="nav-btn" id="prevBtn" onclick="prevChallenge()">‚óÄ</button>
          <div class="challenge-counter">
            Challenge <span id="currentNum">1</span> / <span id="totalNum">20</span>
          </div>
          <button class="nav-btn" id="nextBtn" onclick="nextChallenge()">‚ñ∂</button>
        </div>
        <div class="action-buttons">
          <button class="btn btn-games" onclick="openGames()">
            üéÆ Games
          </button>
          <button class="btn btn-reset" onclick="resetChallenge()">
            Reset
          </button>
          <button class="btn btn-submit" id="submitBtn" onclick="submitCode()">
            Submit
          </button>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div class="sidebar">
        <h2 id="challengeTitle">Challenge Title</h2>
        <div class="description" id="challengeDescription">
          Loading challenge...
        </div>

        <div class="test-cases">
          <h3>Test Cases:</h3>
          <div id="testCases"></div>
        </div>

        <div class="loading-indicator" id="loadingIndicator" style="display: none;">
          <span>Loading Python runtime...</span>
        </div>
      </div>

      <div class="mobile-action-buttons">
        <button class="btn btn-reset" onclick="resetChallenge()">
          Reset
        </button>
        <button class="btn btn-submit" id="submitBtnMobile" onclick="submitCode()">
          Submit
        </button>
      </div>

      <div class="editor-section">
        <div class="editor-tab">
          <span id="fileName">1.py</span>
        </div>
        <div id="editor"></div>
      </div>
    </div>

    <div class="output-section">
      <div class="output-header">Output</div>
      <div class="output-content" id="output"></div>
      <div class="test-results" id="testResults"></div>
    </div>
  </div>

  <!-- Games Modal -->
  <div id="gamesModal" class="games-modal" style="display: none;">
    <div class="games-container">
      <div class="games-header">
        <h2>üéÆ Games</h2>
        <button class="close-btn" onclick="closeGames()">‚úï</button>
      </div>
      <div class="games-menu" id="gamesMenu">
        <button class="game-btn" onclick="startGame('snake')">
          <div class="game-icon">üêç</div>
          <div class="game-name">Snake</div>
        </button>
        <button class="game-btn" onclick="startGame('tetris')">
          <div class="game-icon">üß±</div>
          <div class="game-name">Tetris</div>
        </button>
      </div>
      <div class="game-area" id="gameArea" style="display: none;">
        <div class="game-controls">
          <button class="btn btn-back" onclick="backToMenu()">‚Üê Back</button>
          <div id="gameScore">Score: 0</div>
        </div>
        <canvas id="gameCanvas"></canvas>
        <div id="gameInstructions"></div>
        <div class="mobile-game-controls" id="mobileControls" style="display: none;">
          <div class="control-row">
            <button class="control-btn" onclick="handleMobileControl('up')">‚ñ≤</button>
          </div>
          <div class="control-row">
            <button class="control-btn" onclick="handleMobileControl('left')">‚óÄ</button>
            <button class="control-btn" onclick="handleMobileControl('rotate')">‚Üª</button>
            <button class="control-btn" onclick="handleMobileControl('right')">‚ñ∂</button>
          </div>
          <div class="control-row">
            <button class="control-btn" onclick="handleMobileControl('down')">‚ñº</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

  <script>
    // Storage API fallback using localStorage
    window.storage = {
      get: function(key) {
        return new Promise(function(resolve, reject) {
          try {
            const value = localStorage.getItem(key);
            resolve(value ? { value: value } : null);
          } catch (error) {
            reject(error);
          }
        });
      },
      set: function(key, value, encrypt) {
        return new Promise(function(resolve, reject) {
          try {
            localStorage.setItem(key, value);
            resolve();
          } catch (error) {
            reject(error);
          }
        });
      },
      delete: function(key, encrypt) {
        return new Promise(function(resolve, reject) {
          try {
            localStorage.removeItem(key);
            resolve();
          } catch (error) {
            reject(error);
          }
        });
      }
    };

    var CHALLENGES = [
      {
        id: 1,
        title: "Add Two Numbers",
        category: "math",
        tags: ["basics", "arithmetic"],
        difficulty: 0,
        description: "Write a function that adds two numbers together.",
        starterCode: "def add(a, b):\n    pass",
        tests: [
          { input: [2, 3], expected: 5 },
          { input: [0, 0], expected: 0 },
          { input: [-1, 1], expected: 0 },
          { input: [100, 200], expected: 300 }
        ]
      },
      {
        id: 2,
        title: "Reverse a String",
        category: "string",
        tags: ["basics", "string-manipulation"],
        difficulty: 1,
        description: "Write a function that reverses a string.",
        starterCode: "def reverse_string(s):\n    pass",
        tests: [
          { input: ["hello"], expected: "olleh" },
          { input: [""], expected: "" },
          { input: ["a"], expected: "a" },
          { input: ["Python"], expected: "nohtyP" }
        ]
      },
      {
        id: 3,
        title: "Find Maximum",
        category: "array",
        tags: ["basics", "iteration"],
        difficulty: 1,
        description: "Write a function that finds the maximum number in a list.",
        starterCode: "def find_max(numbers):\n    pass",
        tests: [
          { input: [[1, 2, 3, 4, 5]], expected: 5 },
          { input: [[-1, -2, -3]], expected: -1 },
          { input: [[42]], expected: 42 },
          { input: [[3, 7, 2, 9, 1]], expected: 9 }
        ]
      },
      {
        id: 4,
        title: "Count Vowels",
        category: "string",
        tags: ["basics", "counting", "iteration"],
        difficulty: 1,
        description: "Write a function that counts the number of vowels in a string.",
        starterCode: "def count_vowels(s):\n    pass",
        tests: [
          { input: ["hello"], expected: 2 },
          { input: ["aeiou"], expected: 5 },
          { input: ["xyz"], expected: 0 },
          { input: ["Programming"], expected: 3 }
        ]
      },
      {
        id: 5,
        title: "Is Palindrome",
        category: "string",
        tags: ["basics", "two-pointer", "string-manipulation"],
        difficulty: 2,
        description: "Write a function that checks if a string is a palindrome.",
        starterCode: "def is_palindrome(s):\n    pass",
        tests: [
          { input: ["racecar"], expected: true },
          { input: ["hello"], expected: false },
          { input: ["a"], expected: true },
          { input: ["madam"], expected: true }
        ]
      },
      {
        id: 6,
        title: "Factorial",
        category: "math",
        tags: ["recursion", "iteration", "math"],
        difficulty: 2,
        description: "Write a function that calculates the factorial of a number.",
        starterCode: "def factorial(n):\n    pass",
        tests: [
          { input: [5], expected: 120 },
          { input: [0], expected: 1 },
          { input: [1], expected: 1 },
          { input: [4], expected: 24 }
        ]
      },
      {
        id: 7,
        title: "Remove Duplicates",
        category: "array",
        tags: ["array", "hashmap", "order-preservation"],
        difficulty: 2,
        description: "Write a function that removes duplicates from a list while preserving order.",
        starterCode: "def remove_duplicates(lst):\n    pass",
        tests: [
          { input: [[1, 2, 2, 3, 4, 4, 5]], expected: [1, 2, 3, 4, 5] },
          { input: [[1, 1, 1]], expected: [1] },
          { input: [[]], expected: [] },
          { input: [["a", "b", "a", "c"]], expected: ["a", "b", "c"] }
        ]
      },
      {
        id: 8,
        title: "FizzBuzz",
        category: "algorithm",
        tags: ["iteration", "conditionals", "modulo"],
        difficulty: 2,
        description: "Return a list of numbers from 1 to n, replacing multiples of 3 with 'Fizz', multiples of 5 with 'Buzz', and multiples of both with 'FizzBuzz'.",
        starterCode: "def fizzbuzz(n):\n    pass",
        tests: [
          { input: [15], expected: [1, 2, "Fizz", 4, "Buzz", "Fizz", 7, 8, "Fizz", "Buzz", 11, "Fizz", 13, 14, "FizzBuzz"] },
          { input: [5], expected: [1, 2, "Fizz", 4, "Buzz"] },
          { input: [3], expected: [1, 2, "Fizz"] }
        ]
      },
      {
        id: 9,
        title: "Sum of Digits",
        category: "math",
        tags: ["math", "string-manipulation", "iteration"],
        difficulty: 2,
        description: "Write a function that returns the sum of all digits in a number.",
        starterCode: "def sum_of_digits(n):\n    pass",
        tests: [
          { input: [123], expected: 6 },
          { input: [0], expected: 0 },
          { input: [9999], expected: 36 },
          { input: [100], expected: 1 }
        ]
      },
      {
        id: 10,
        title: "Is Prime",
        category: "math",
        tags: ["math", "optimization", "iteration"],
        difficulty: 3,
        description: "Write a function that checks if a number is prime.",
        starterCode: "def is_prime(n):\n    pass",
        tests: [
          { input: [7], expected: true },
          { input: [4], expected: false },
          { input: [2], expected: true },
          { input: [1], expected: false },
          { input: [17], expected: true }
        ]
      },
      {
        id: 11,
        title: "Merge Sorted Lists",
        category: "array",
        tags: ["array", "two-pointer", "sorting", "merge"],
        difficulty: 3,
        description: "Write a function that merges two sorted lists into one sorted list.",
        starterCode: "def merge_sorted(list1, list2):\n    pass",
        tests: [
          { input: [[1, 3, 5], [2, 4, 6]], expected: [1, 2, 3, 4, 5, 6] },
          { input: [[1, 2], [3, 4]], expected: [1, 2, 3, 4] },
          { input: [[], [1, 2]], expected: [1, 2] },
          { input: [[5], [1, 2, 3]], expected: [1, 2, 3, 5] }
        ]
      },
      {
        id: 12,
        title: "Count Word Frequency",
        category: "string",
        tags: ["hashmap", "string", "counting"],
        difficulty: 3,
        description: "Write a function that counts the frequency of each word in a string.",
        starterCode: "def word_frequency(text):\n    pass",
        tests: [
          { input: ["hello world hello"], expected: {"hello": 2, "world": 1} },
          { input: ["the quick brown fox"], expected: {"the": 1, "quick": 1, "brown": 1, "fox": 1} },
          { input: [""], expected: {} }
        ]
      },
      {
        id: 13,
        title: "Longest Word",
        category: "string",
        tags: ["string", "iteration", "comparison"],
        difficulty: 2,
        description: "Write a function that finds the longest word in a sentence.",
        starterCode: "def longest_word(sentence):\n    pass",
        tests: [
          { input: ["the quick brown fox"], expected: "quick" },
          { input: ["hello world"], expected: "hello" },
          { input: ["Python programming is fun"], expected: "programming" }
        ]
      },
      {
        id: 14,
        title: "Binary to Decimal",
        category: "math",
        tags: ["math", "conversion", "binary"],
        difficulty: 3,
        description: "Write a function that converts a binary string to decimal.",
        starterCode: "def binary_to_decimal(binary_str):\n    pass",
        tests: [
          { input: ["101"], expected: 5 },
          { input: ["1010"], expected: 10 },
          { input: ["1111"], expected: 15 },
          { input: ["10000"], expected: 16 }
        ]
      },
      {
        id: 15,
        title: "Two Sum",
        category: "array",
        tags: ["array", "hashmap", "optimization"],
        difficulty: 4,
        description: "Given a list of numbers and a target, return indices of two numbers that add up to the target.",
        starterCode: "def two_sum(nums, target):\n    pass",
        tests: [
          { input: [[2, 7, 11, 15], 9], expected: [0, 1] },
          { input: [[3, 2, 4], 6], expected: [1, 2] },
          { input: [[3, 3], 6], expected: [0, 1] }
        ]
      },
      {
        id: 16,
        title: "Anagram Check",
        category: "string",
        tags: ["string", "hashmap", "sorting"],
        difficulty: 3,
        description: "Write a function that checks if two strings are anagrams.",
        starterCode: "def are_anagrams(str1, str2):\n    pass",
        tests: [
          { input: ["listen", "silent"], expected: true },
          { input: ["hello", "world"], expected: false },
          { input: ["anagram", "nagaram"], expected: true },
          { input: ["rat", "car"], expected: false }
        ]
      },
      {
        id: 17,
        title: "Fibonacci Sequence",
        category: "math",
        tags: ["recursion", "dynamic-programming", "math"],
        difficulty: 3,
        description: "Write a function that returns the nth Fibonacci number.",
        starterCode: "def fibonacci(n):\n    pass",
        tests: [
          { input: [0], expected: 0 },
          { input: [1], expected: 1 },
          { input: [5], expected: 5 },
          { input: [10], expected: 55 }
        ]
      },
      {
        id: 18,
        title: "Rotate Array",
        category: "array",
        tags: ["array", "manipulation", "modulo"],
        difficulty: 4,
        description: "Write a function that rotates an array to the right by k steps.",
        starterCode: "def rotate_array(arr, k):\n    pass",
        tests: [
          { input: [[1, 2, 3, 4, 5], 2], expected: [4, 5, 1, 2, 3] },
          { input: [[1, 2], 3], expected: [2, 1] },
          { input: [[1, 2, 3], 0], expected: [1, 2, 3] }
        ]
      },
      {
        id: 19,
        title: "Valid Parentheses",
        category: "stack",
        tags: ["stack", "string", "matching"],
        difficulty: 4,
        description: "Write a function that checks if a string of parentheses is valid.",
        starterCode: "def valid_parentheses(s):\n    pass",
        tests: [
          { input: ["()"], expected: true },
          { input: ["()[]{}"], expected: true },
          { input: ["(]"], expected: false },
          { input: ["([)]"], expected: false },
          { input: ["{[]}"], expected: true }
        ]
      },
      {
        id: 20,
        title: "Longest Common Prefix",
        category: "string",
        tags: ["string", "comparison", "iteration"],
        difficulty: 3,
        description: "Write a function that finds the longest common prefix among an array of strings.",
        starterCode: "def longest_common_prefix(strs):\n    pass",
        tests: [
          { input: [["flower", "flow", "flight"]], expected: "fl" },
          { input: [["dog", "racecar", "car"]], expected: "" },
          { input: [["interspecies", "interstellar", "interstate"]], expected: "inters" }
        ]
      },
      {
        id: 21,
        title: "Remove Vowels",
        category: "string",
        tags: ["string", "filtering", "iteration"],
        difficulty: 2,
        description: "Write a function that removes all vowels from a string.",
        starterCode: "def remove_vowels(s):\n    pass",
        tests: [
          { input: ["hello"], expected: "hll" },
          { input: ["programming"], expected: "prgrmmng" },
          { input: ["aeiou"], expected: "" },
          { input: ["xyz"], expected: "xyz" }
        ]
      },
      {
        id: 22,
        title: "Title Case",
        category: "string",
        tags: ["string", "string-manipulation", "formatting"],
        difficulty: 2,
        description: "Write a function that converts a string to title case (first letter of each word capitalized).",
        starterCode: "def title_case(s):\n    pass",
        tests: [
          { input: ["hello world"], expected: "Hello World" },
          { input: ["the quick brown fox"], expected: "The Quick Brown Fox" },
          { input: ["python"], expected: "Python" },
          { input: [""], expected: "" }
        ]
      },
      {
        id: 23,
        title: "Find Second Largest",
        category: "array",
        tags: ["array", "sorting", "comparison"],
        difficulty: 3,
        description: "Write a function that finds the second largest number in a list.",
        starterCode: "def second_largest(numbers):\n    pass",
        tests: [
          { input: [[1, 2, 3, 4, 5]], expected: 4 },
          { input: [[10, 5, 8, 12, 3]], expected: 10 },
          { input: [[7, 7, 7, 1]], expected: 1 },
          { input: [[5, 5]], expected: 5 }
        ]
      },
      {
        id: 24,
        title: "Flatten List",
        category: "array",
        tags: ["array", "iteration", "nested-structures"],
        difficulty: 2,
        description: "Write a function that flattens a nested list (one level deep).",
        starterCode: "def flatten(lst):\n    pass",
        tests: [
          { input: [[[1, 2], [3, 4], [5]]], expected: [1, 2, 3, 4, 5] },
          { input: [[[1], [2], [3]]], expected: [1, 2, 3] },
          { input: [[[]]], expected: [] },
          { input: [[[1, 2, 3]]], expected: [1, 2, 3] }
        ]
      },
      {
        id: 25,
        title: "Reverse Words",
        category: "string",
        tags: ["string", "array", "manipulation"],
        difficulty: 2,
        description: "Write a function that reverses the order of words in a sentence.",
        starterCode: "def reverse_words(sentence):\n    pass",
        tests: [
          { input: ["hello world"], expected: "world hello" },
          { input: ["the quick brown fox"], expected: "fox brown quick the" },
          { input: ["python"], expected: "python" },
          { input: [""], expected: "" }
        ]
      },
      {
        id: 26,
        title: "Is Leap Year",
        category: "math",
        tags: ["math", "conditionals", "date"],
        difficulty: 2,
        description: "Write a function that checks if a year is a leap year.",
        starterCode: "def is_leap_year(year):\n    pass",
        tests: [
          { input: [2020], expected: true },
          { input: [2021], expected: false },
          { input: [2000], expected: true },
          { input: [1900], expected: false },
          { input: [2024], expected: true }
        ]
      },
      {
        id: 27,
        title: "Find Missing Number",
        category: "array",
        tags: ["array", "math", "bit-manipulation"],
        difficulty: 4,
        description: "Given a list containing n-1 numbers from 0 to n, find the missing number.",
        starterCode: "def find_missing(numbers):\n    pass",
        tests: [
          { input: [[0, 1, 3]], expected: 2 },
          { input: [[0, 1, 2, 3, 4, 6]], expected: 5 },
          { input: [[1]], expected: 0 },
          { input: [[0]], expected: 1 }
        ]
      },
      {
        id: 28,
        title: "Compress String",
        category: "string",
        tags: ["string", "iteration", "counting"],
        difficulty: 3,
        description: "Write a function that compresses a string by counting consecutive characters (e.g., 'aaabbc' -> 'a3b2c1').",
        starterCode: "def compress_string(s):\n    pass",
        tests: [
          { input: ["aaabbc"], expected: "a3b2c1" },
          { input: ["abc"], expected: "a1b1c1" },
          { input: ["aaa"], expected: "a3" },
          { input: [""], expected: "" }
        ]
      },
      {
        id: 29,
        title: "Move Zeros",
        category: "array",
        tags: ["array", "two-pointer", "in-place"],
        difficulty: 3,
        description: "Write a function that moves all zeros in a list to the end while maintaining the order of other elements.",
        starterCode: "def move_zeros(numbers):\n    pass",
        tests: [
          { input: [[0, 1, 0, 3, 12]], expected: [1, 3, 12, 0, 0] },
          { input: [[1, 2, 3]], expected: [1, 2, 3] },
          { input: [[0, 0, 1]], expected: [1, 0, 0] },
          { input: [[0]], expected: [0] }
        ]
      },
      {
        id: 30,
        title: "Find Intersection",
        category: "array",
        tags: ["array", "hashmap", "set-operations"],
        difficulty: 3,
        description: "Write a function that finds the intersection of two lists (common elements).",
        starterCode: "def intersection(list1, list2):\n    pass",
        tests: [
          { input: [[1, 2, 3], [2, 3, 4]], expected: [2, 3] },
          { input: [[1, 1, 2], [1, 3]], expected: [1] },
          { input: [[1, 2, 3], [4, 5, 6]], expected: [] },
          { input: [[], [1, 2]], expected: [] }
        ]
      },
      {
        id: 31,
        title: "Is Power of Two",
        category: "math",
        tags: ["math", "bit-manipulation", "optimization"],
        difficulty: 3,
        description: "Write a function that checks if a number is a power of two.",
        starterCode: "def is_power_of_two(n):\n    pass",
        tests: [
          { input: [16], expected: true },
          { input: [18], expected: false },
          { input: [1], expected: true },
          { input: [0], expected: false },
          { input: [64], expected: true }
        ]
      },
      {
        id: 32,
        title: "Chunk Array",
        category: "array",
        tags: ["array", "slicing", "iteration"],
        difficulty: 3,
        description: "Write a function that splits a list into chunks of a given size.",
        starterCode: "def chunk_array(lst, size):\n    pass",
        tests: [
          { input: [[1, 2, 3, 4, 5], 2], expected: [[1, 2], [3, 4], [5]] },
          { input: [[1, 2, 3, 4], 2], expected: [[1, 2], [3, 4]] },
          { input: [[1, 2, 3], 5], expected: [[1, 2, 3]] },
          { input: [[], 2], expected: [] }
        ]
      },
      {
        id: 33,
        title: "First Non-Repeating Character",
        category: "string",
        tags: ["string", "hashmap", "counting"],
        difficulty: 4,
        description: "Write a function that finds the first non-repeating character in a string.",
        starterCode: "def first_unique_char(s):\n    pass",
        tests: [
          { input: ["leetcode"], expected: "l" },
          { input: ["loveleetcode"], expected: "v" },
          { input: ["aabb"], expected: "" },
          { input: [""], expected: "" }
        ]
      },
      {
        id: 34,
        title: "Greatest Common Divisor",
        category: "math",
        tags: ["math", "recursion", "euclidean-algorithm"],
        difficulty: 4,
        description: "Write a function that finds the GCD (greatest common divisor) of two numbers.",
        starterCode: "def gcd(a, b):\n    pass",
        tests: [
          { input: [12, 8], expected: 4 },
          { input: [17, 5], expected: 1 },
          { input: [100, 50], expected: 50 },
          { input: [7, 7], expected: 7 }
        ]
      },
      {
        id: 35,
        title: "Remove Duplicates Sorted",
        category: "array",
        tags: ["array", "two-pointer", "in-place"],
        difficulty: 3,
        description: "Write a function that removes duplicates from a sorted list and returns the length of unique elements.",
        starterCode: "def remove_duplicates_sorted(numbers):\n    pass",
        tests: [
          { input: [[1, 1, 2, 2, 3]], expected: 3 },
          { input: [[1, 2, 3]], expected: 3 },
          { input: [[1, 1, 1]], expected: 1 },
          { input: [[]], expected: 0 }
        ]
      },
      {
        id: 36,
        title: "Pascal's Triangle Row",
        category: "math",
        tags: ["math", "dynamic-programming", "combinatorics"],
        difficulty: 4,
        description: "Write a function that returns the nth row of Pascal's triangle (0-indexed).",
        starterCode: "def pascal_row(n):\n    pass",
        tests: [
          { input: [0], expected: [1] },
          { input: [1], expected: [1, 1] },
          { input: [2], expected: [1, 2, 1] },
          { input: [3], expected: [1, 3, 3, 1] },
          { input: [4], expected: [1, 4, 6, 4, 1] }
        ]
      },
      {
        id: 37,
        title: "String Rotation",
        category: "string",
        tags: ["string", "string-manipulation", "pattern-matching"],
        difficulty: 4,
        description: "Write a function that checks if one string is a rotation of another.",
        starterCode: "def is_rotation(s1, s2):\n    pass",
        tests: [
          { input: ["waterbottle", "erbottlewat"], expected: true },
          { input: ["hello", "llohe"], expected: true },
          { input: ["hello", "world"], expected: false },
          { input: ["abc", "bca"], expected: true }
        ]
      },
      {
        id: 38,
        title: "Find Peak Element",
        category: "array",
        tags: ["array", "binary-search", "optimization"],
        difficulty: 5,
        description: "Write a function that finds a peak element in a list (element greater than its neighbors).",
        starterCode: "def find_peak(numbers):\n    pass",
        tests: [
          { input: [[1, 2, 3, 1]], expected: 3 },
          { input: [[1, 2, 1, 3, 5, 6, 4]], expected: 6 },
          { input: [[5]], expected: 5 },
          { input: [[1, 2, 3]], expected: 3 }
        ]
      },
      {
        id: 39,
        title: "Count Consonants",
        category: "string",
        tags: ["string", "counting", "iteration"],
        difficulty: 2,
        description: "Write a function that counts the number of consonants in a string.",
        starterCode: "def count_consonants(s):\n    pass",
        tests: [
          { input: ["hello"], expected: 3 },
          { input: ["programming"], expected: 8 },
          { input: ["aeiou"], expected: 0 },
          { input: ["xyz"], expected: 3 }
        ]
      },
      {
        id: 40,
        title: "Majority Element",
        category: "array",
        tags: ["array", "hashmap", "boyer-moore"],
        difficulty: 4,
        description: "Write a function that finds the majority element (appears more than n/2 times) in a list.",
        starterCode: "def majority_element(numbers):\n    pass",
        tests: [
          { input: [[3, 2, 3]], expected: 3 },
          { input: [[2, 2, 1, 1, 1, 2, 2]], expected: 2 },
          { input: [[1]], expected: 1 },
          { input: [[1, 1, 2]], expected: 1 }
        ]
      },
      {
        id: 41,
        title: "Product Except Self",
        category: "array",
        tags: ["array", "prefix-sum", "optimization"],
        difficulty: 5,
        description: "Write a function that returns a list where each element is the product of all elements except itself.",
        starterCode: "def product_except_self(numbers):\n    pass",
        tests: [
          { input: [[1, 2, 3, 4]], expected: [24, 12, 8, 6] },
          { input: [[2, 3, 4]], expected: [12, 8, 6] },
          { input: [[1, 1]], expected: [1, 1] },
          { input: [[5]], expected: [1] }
        ]
      },
      {
        id: 42,
        title: "Camel Case to Snake Case",
        category: "string",
        tags: ["string", "regex", "formatting"],
        difficulty: 3,
        description: "Write a function that converts a camelCase string to snake_case.",
        starterCode: "def camel_to_snake(s):\n    pass",
        tests: [
          { input: ["camelCase"], expected: "camel_case" },
          { input: ["helloWorld"], expected: "hello_world" },
          { input: ["myVariable"], expected: "my_variable" },
          { input: ["simple"], expected: "simple" }
        ]
      },
      {
        id: 43,
        title: "Find Duplicates",
        category: "array",
        tags: ["array", "hashmap", "set-operations"],
        difficulty: 3,
        description: "Write a function that finds all duplicate elements in a list.",
        starterCode: "def find_duplicates(numbers):\n    pass",
        tests: [
          { input: [[4, 3, 2, 7, 8, 2, 3, 1]], expected: [2, 3] },
          { input: [[1, 1, 2]], expected: [1] },
          { input: [[1, 2, 3]], expected: [] },
          { input: [[1, 1, 1]], expected: [1] }
        ]
      },
      {
        id: 44,
        title: "Is Armstrong Number",
        category: "math",
        tags: ["math", "digit-manipulation"],
        difficulty: 3,
        description: "Write a function that checks if a number is an Armstrong number (sum of cubes of digits equals the number).",
        starterCode: "def is_armstrong(n):\n    pass",
        tests: [
          { input: [153], expected: true },
          { input: [370], expected: true },
          { input: [123], expected: false },
          { input: [9], expected: true }
        ]
      },
      {
        id: 45,
        title: "Longest Substring Without Repeating",
        category: "string",
        tags: ["string", "sliding-window", "hashmap"],
        difficulty: 6,
        description: "Write a function that finds the length of the longest substring without repeating characters.",
        starterCode: "def longest_unique_substring(s):\n    pass",
        tests: [
          { input: ["abcabcbb"], expected: 3 },
          { input: ["bbbbb"], expected: 1 },
          { input: ["pwwkew"], expected: 3 },
          { input: [""], expected: 0 }
        ]
      },
      {
        id: 46,
        title: "Find Union",
        category: "array",
        tags: ["array", "set-operations", "hashmap"],
        difficulty: 2,
        description: "Write a function that finds the union of two lists (all unique elements from both).",
        starterCode: "def union(list1, list2):\n    pass",
        tests: [
          { input: [[1, 2, 3], [3, 4, 5]], expected: [1, 2, 3, 4, 5] },
          { input: [[1, 2], [2, 3]], expected: [1, 2, 3] },
          { input: [[], [1, 2]], expected: [1, 2] },
          { input: [[1, 1], [1, 2]], expected: [1, 2] }
        ]
      },
      {
        id: 47,
        title: "Is Perfect Square",
        category: "math",
        tags: ["math", "binary-search", "sqrt"],
        difficulty: 3,
        description: "Write a function that checks if a number is a perfect square.",
        starterCode: "def is_perfect_square(n):\n    pass",
        tests: [
          { input: [16], expected: true },
          { input: [14], expected: false },
          { input: [1], expected: true },
          { input: [0], expected: true },
          { input: [25], expected: true }
        ]
      },
      {
        id: 48,
        title: "Reverse Integer",
        category: "math",
        tags: ["math", "digit-manipulation"],
        difficulty: 3,
        description: "Write a function that reverses the digits of an integer.",
        starterCode: "def reverse_integer(n):\n    pass",
        tests: [
          { input: [123], expected: 321 },
          { input: [-123], expected: -321 },
          { input: [120], expected: 21 },
          { input: [0], expected: 0 }
        ]
      },
      {
        id: 49,
        title: "Contains Duplicate",
        category: "array",
        tags: ["array", "hashmap", "set-operations"],
        difficulty: 2,
        description: "Write a function that checks if a list contains any duplicate elements.",
        starterCode: "def contains_duplicate(numbers):\n    pass",
        tests: [
          { input: [[1, 2, 3, 1]], expected: true },
          { input: [[1, 2, 3, 4]], expected: false },
          { input: [[1, 1, 1, 3, 3, 4, 3, 2, 4, 2]], expected: true },
          { input: [[]], expected: false }
        ]
      },
      {
        id: 50,
        title: "Happy Number",
        category: "math",
        tags: ["math", "hashmap", "cycle-detection"],
        difficulty: 5,
        description: "Write a function that checks if a number is a happy number (repeatedly sum squares of digits until reaching 1 or a cycle).",
        starterCode: "def is_happy(n):\n    pass",
        tests: [
          { input: [19], expected: true },
          { input: [2], expected: false },
          { input: [1], expected: true },
          { input: [7], expected: true }
        ]
      }
    ];

    let currentChallenge = 0;
    let editor = null;
    let pyodide = null;
    let pyodideLoaded = false;
    let storageLoaded = false;

    // Games Variables
    let currentGame = null;
    let gameInterval = null;
    let gameAnimationFrame = null;

    async function loadProgress() {
      try {
        const savedChallenge = await window.storage.get('current-challenge');
        if (savedChallenge) {
          currentChallenge = parseInt(savedChallenge.value);
        }
      } catch (error) {
        console.log('No saved progress');
      }
      storageLoaded = true;
      await loadChallenge();
    }

    async function loadChallenge() {
      const challenge = CHALLENGES[currentChallenge];
      document.getElementById('challengeTitle').textContent = challenge.title;
      document.getElementById('challengeDescription').textContent = challenge.description;
      document.getElementById('fileName').textContent = (currentChallenge + 1) + '.py';
      document.getElementById('currentNum').textContent = currentChallenge + 1;
      document.getElementById('totalNum').textContent = CHALLENGES.length;
      
      const testCasesDiv = document.getElementById('testCases');
      testCasesDiv.innerHTML = challenge.tests.map(function(test, idx) {
        // Format input display - if single argument, show it directly; if multiple, show with commas
        let inputDisplay;
        if (test.input.length === 1) {
          inputDisplay = JSON.stringify(test.input[0]);
        } else {
          inputDisplay = test.input.map(function(arg) { return JSON.stringify(arg); }).join(', ');
        }
        return '<div class="test-case"><div>Input: <code class="test-input">' + inputDisplay + '</code></div><div>Expected: <code class="test-expected">' + JSON.stringify(test.expected) + '</code></div></div>';
      }).join('');

      document.getElementById('prevBtn').disabled = currentChallenge === 0;
      document.getElementById('nextBtn').disabled = currentChallenge === CHALLENGES.length - 1;

      let code;
      try {
        const savedCode = await window.storage.get('challenge-' + currentChallenge);
        code = savedCode ? savedCode.value : challenge.starterCode;
      } catch (error) {
        code = challenge.starterCode;
      }

      if (editor) {
        editor.setValue(code);
      }

      document.getElementById('output').textContent = '';
      document.getElementById('testResults').innerHTML = '';
    }

    async function changeChallenge(index) {
      currentChallenge = index;
      try {
        await window.storage.set('current-challenge', index.toString(), false);
      } catch (error) {
        console.error('Failed to save challenge index');
      }
      await loadChallenge();
    }

    function prevChallenge() {
      if (currentChallenge > 0) {
        changeChallenge(currentChallenge - 1);
      }
    }

    function nextChallenge() {
      if (currentChallenge < CHALLENGES.length - 1) {
        changeChallenge(currentChallenge + 1);
      }
    }

    async function resetChallenge() {
      const challenge = CHALLENGES[currentChallenge];
      editor.setValue(challenge.starterCode);
      document.getElementById('output').textContent = '';
      document.getElementById('testResults').innerHTML = '';
      
      try {
        await window.storage.delete('challenge-' + currentChallenge, false);
      } catch (error) {
        console.error('Failed to delete saved code');
      }
    }

    async function saveCode(code) {
      try {
        await window.storage.set('challenge-' + currentChallenge, code, false);
      } catch (error) {
        console.error('Failed to save code');
      }
    }

    async function submitCode() {
      if (!pyodideLoaded) {
        document.getElementById('output').textContent = 'Python runtime is still loading...';
        return;
      }

      const submitBtn = document.getElementById('submitBtn');
      const submitBtnMobile = document.getElementById('submitBtnMobile');
      submitBtn.disabled = true;
      submitBtn.innerHTML = 'Running...';
      submitBtnMobile.disabled = true;
      submitBtnMobile.innerHTML = 'Running...';
      
      document.getElementById('output').textContent = '';
      document.getElementById('testResults').innerHTML = '';

      const challenge = CHALLENGES[currentChallenge];
      const code = editor.getValue();
      const results = [];

      try {
        await pyodide.runPythonAsync('import sys\nfrom io import StringIO\nsys.stdout = StringIO()\nsys.stderr = StringIO()');

        await pyodide.runPythonAsync(code);

        for (let i = 0; i < challenge.tests.length; i++) {
          const test = challenge.tests[i];
          try {
            const funcName = code.match(/def\s+(\w+)\s*\(/)[1];
            const args = JSON.stringify(test.input);
            const result = await pyodide.runPythonAsync('import json; json.dumps(' + funcName + '(*' + args + '))');
            const parsed = JSON.parse(result);
            const passed = JSON.stringify(parsed) === JSON.stringify(test.expected);
            
            results.push({
              passed: passed,
              input: test.input,
              expected: test.expected,
              actual: parsed
            });
          } catch (error) {
            results.push({
              passed: false,
              input: test.input,
              expected: test.expected,
              error: error.message
            });
          }
        }

        const stdout = await pyodide.runPythonAsync('sys.stdout.getvalue()');
        const stderr = await pyodide.runPythonAsync('sys.stderr.getvalue()');

        const passed = results.filter(function(r) { return r.passed; }).length;
        const total = results.length;
        
        let outputMsg = '';
        if (stdout) {
          outputMsg += 'Debug Output:\n' + stdout + '\n\n';
        }
        if (stderr) {
          outputMsg += 'Errors:\n' + stderr + '\n\n';
        }
        
        if (passed === total) {
          outputMsg += 'All tests passed! (' + passed + '/' + total + ')';
        } else {
          outputMsg += 'Tests passed: ' + passed + '/' + total;
        }
        
        document.getElementById('output').textContent = outputMsg;

        const testResultsHtml = results.map(function(result, idx) {
          // Format input display consistently
          let inputDisplay;
          if (result.input.length === 1) {
            inputDisplay = JSON.stringify(result.input[0]);
          } else {
            inputDisplay = result.input.map(function(arg) { return JSON.stringify(arg); }).join(', ');
          }
          return '<div class="test-result ' + (result.passed ? 'passed' : 'failed') + '"><div class="test-result-title">Test ' + (idx + 1) + ': ' + (result.passed ? 'Passed' : 'Failed') + '</div><div class="test-result-details"><div>Input: ' + inputDisplay + '</div><div>Expected: ' + JSON.stringify(result.expected) + '</div>' + (result.error ? '<div>Error: ' + result.error + '</div>' : '<div>Got: ' + JSON.stringify(result.actual) + '</div>') + '</div></div>';
        }).join('');
        
        document.getElementById('testResults').innerHTML = testResultsHtml;

      } catch (error) {
        document.getElementById('output').textContent = 'Error: ' + error.message;
      }

      submitBtn.disabled = false;
      submitBtn.innerHTML = 'Submit';
      submitBtnMobile.disabled = false;
      submitBtnMobile.innerHTML = 'Submit';
    }

    document.getElementById('loadingIndicator').style.display = 'flex';
    
    require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
    require(['vs/editor/editor.main'], async function() {
      await loadProgress();
      
      const challenge = CHALLENGES[currentChallenge];
      let code;
      try {
        const savedCode = await window.storage.get('challenge-' + currentChallenge);
        code = savedCode ? savedCode.value : challenge.starterCode;
      } catch (error) {
        code = challenge.starterCode;
      }

      editor = monaco.editor.create(document.getElementById('editor'), {
        value: code,
        language: 'python',
        theme: 'vs-dark',
        minimap: { enabled: false },
        fontSize: 15,
        lineNumbers: 'on',
        roundedSelection: false,
        scrollBeyondLastLine: false,
        automaticLayout: true
      });

      editor.onDidChangeModelContent(function() {
        saveCode(editor.getValue());
      });
    });

    loadPyodide({
      indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/'
    }).then(function(py) {
      pyodide = py;
      pyodideLoaded = true;
      document.getElementById('loadingIndicator').style.display = 'none';
      document.getElementById('submitBtn').disabled = false;
      document.getElementById('submitBtnMobile').disabled = false;
    });

    // Games Functions
    function openGames() {
      document.getElementById('gamesModal').style.display = 'flex';
    }

    function closeGames() {
      document.getElementById('gamesModal').style.display = 'none';
      if (currentGame) {
        stopCurrentGame();
      }
      document.getElementById('gamesMenu').style.display = 'grid';
      document.getElementById('gameArea').style.display = 'none';
    }

    function backToMenu() {
      stopCurrentGame();
      document.getElementById('gamesMenu').style.display = 'grid';
      document.getElementById('gameArea').style.display = 'none';
      document.getElementById('mobileControls').style.display = 'none';
    }

    function stopCurrentGame() {
      if (gameInterval) {
        clearInterval(gameInterval);
        gameInterval = null;
      }
      if (gameAnimationFrame) {
        cancelAnimationFrame(gameAnimationFrame);
        gameAnimationFrame = null;
      }
      currentGame = null;
      document.removeEventListener('keydown', snakeKeyHandler);
      document.removeEventListener('keydown', tetrisKeyHandler);
    }

    function startGame(game) {
      document.getElementById('gamesMenu').style.display = 'none';
      document.getElementById('gameArea').style.display = 'block';
      currentGame = game;

      // Show mobile controls on mobile devices
      if (window.innerWidth <= 768) {
        document.getElementById('mobileControls').style.display = 'flex';
      }

      if (game === 'snake') {
        initSnake();
      } else if (game === 'tetris') {
        initTetris();
      }
    }

    function handleMobileControl(direction) {
      if (currentGame === 'snake') {
        if (direction === 'up' && snakeDirection !== 'down') snakeDirection = 'up';
        else if (direction === 'down' && snakeDirection !== 'up') snakeDirection = 'down';
        else if (direction === 'left' && snakeDirection !== 'right') snakeDirection = 'left';
        else if (direction === 'right' && snakeDirection !== 'left') snakeDirection = 'right';
      } else if (currentGame === 'tetris') {
        if (direction === 'left') moveTetrisPiece(-1, 0);
        else if (direction === 'right') moveTetrisPiece(1, 0);
        else if (direction === 'down') moveTetrisPiece(0, 1);
        else if (direction === 'up' || direction === 'rotate') rotateTetrisPiece();
      }
    }

    // Snake Game
    let snake, snakeDirection, snakeFood, snakeScore, snakeCanvas, snakeCtx;

    function snakeKeyHandler(e) {
      if (!currentGame || currentGame !== 'snake') return;
      const key = e.key;
      if (key === 'ArrowUp' && snakeDirection !== 'down') {
        snakeDirection = 'up';
        e.preventDefault();
      } else if (key === 'ArrowDown' && snakeDirection !== 'up') {
        snakeDirection = 'down';
        e.preventDefault();
      } else if (key === 'ArrowLeft' && snakeDirection !== 'right') {
        snakeDirection = 'left';
        e.preventDefault();
      } else if (key === 'ArrowRight' && snakeDirection !== 'left') {
        snakeDirection = 'right';
        e.preventDefault();
      }
    }

    function initSnake() {
      snakeCanvas = document.getElementById('gameCanvas');
      snakeCtx = snakeCanvas.getContext('2d');
      snakeCanvas.width = 400;
      snakeCanvas.height = 400;

      snake = [{x: 10, y: 10}];
      snakeDirection = 'right';
      snakeScore = 0;
      placeSnakeFood();

      document.getElementById('gameScore').textContent = 'Score: 0';
      document.getElementById('gameInstructions').innerHTML = '<strong>Controls:</strong> Use arrow keys to move the snake. Eat the red food to grow!';

      document.addEventListener('keydown', snakeKeyHandler);
      gameInterval = setInterval(updateSnake, 100);
    }

    function placeSnakeFood() {
      snakeFood = {
        x: Math.floor(Math.random() * 20),
        y: Math.floor(Math.random() * 20)
      };
    }

    function updateSnake() {
      const head = {x: snake[0].x, y: snake[0].y};

      if (snakeDirection === 'up') head.y--;
      if (snakeDirection === 'down') head.y++;
      if (snakeDirection === 'left') head.x--;
      if (snakeDirection === 'right') head.x++;

      // Check wall collision
      if (head.x < 0 || head.x >= 20 || head.y < 0 || head.y >= 20) {
        gameOver('Snake');
        return;
      }

      // Check self collision
      for (let segment of snake) {
        if (segment.x === head.x && segment.y === head.y) {
          gameOver('Snake');
          return;
        }
      }

      snake.unshift(head);

      // Check food collision
      if (head.x === snakeFood.x && head.y === snakeFood.y) {
        snakeScore += 10;
        document.getElementById('gameScore').textContent = 'Score: ' + snakeScore;
        placeSnakeFood();
      } else {
        snake.pop();
      }

      drawSnake();
    }

    function drawSnake() {
      snakeCtx.fillStyle = '#fff';
      snakeCtx.fillRect(0, 0, snakeCanvas.width, snakeCanvas.height);

      // Draw snake
      snakeCtx.fillStyle = '#4ecdc4';
      for (let segment of snake) {
        snakeCtx.fillRect(segment.x * 20, segment.y * 20, 19, 19);
      }

      // Draw food
      snakeCtx.fillStyle = '#ff6b35';
      snakeCtx.fillRect(snakeFood.x * 20, snakeFood.y * 20, 19, 19);
    }

    // Tetris Game
    let tetrisBoard, tetrisCurrentPiece, tetrisScore, tetrisCanvas, tetrisCtx;
    const TETRIS_COLS = 10;
    const TETRIS_ROWS = 20;
    const BLOCK_SIZE = 20;

    const TETRIS_PIECES = [
      [[1,1,1,1]], // I
      [[1,1],[1,1]], // O
      [[0,1,0],[1,1,1]], // T
      [[1,0,0],[1,1,1]], // L
      [[0,0,1],[1,1,1]], // J
      [[0,1,1],[1,1,0]], // S
      [[1,1,0],[0,1,1]]  // Z
    ];

    const TETRIS_COLORS = ['#ff6b35', '#4ecdc4', '#ffd700', '#4a90e2', '#f7f7f7', '#ff6b35', '#4ecdc4'];

    function tetrisKeyHandler(e) {
      if (!currentGame || currentGame !== 'tetris') return;
      const key = e.key;
      if (key === 'ArrowLeft') {
        moveTetrisPiece(-1, 0);
        e.preventDefault();
      } else if (key === 'ArrowRight') {
        moveTetrisPiece(1, 0);
        e.preventDefault();
      } else if (key === 'ArrowDown') {
        moveTetrisPiece(0, 1);
        e.preventDefault();
      } else if (key === 'ArrowUp' || key === ' ') {
        rotateTetrisPiece();
        e.preventDefault();
      }
    }

    function initTetris() {
      tetrisCanvas = document.getElementById('gameCanvas');
      tetrisCtx = tetrisCanvas.getContext('2d');
      tetrisCanvas.width = TETRIS_COLS * BLOCK_SIZE;
      tetrisCanvas.height = TETRIS_ROWS * BLOCK_SIZE;

      tetrisBoard = Array(TETRIS_ROWS).fill(null).map(() => Array(TETRIS_COLS).fill(0));
      tetrisScore = 0;
      spawnTetrisPiece();

      document.getElementById('gameScore').textContent = 'Score: 0';
      document.getElementById('gameInstructions').innerHTML = '<strong>Controls:</strong> Arrow keys to move, Up/Space to rotate. Complete lines to score!';

      document.addEventListener('keydown', tetrisKeyHandler);
      gameInterval = setInterval(updateTetris, 500);
    }

    function spawnTetrisPiece() {
      const pieceIndex = Math.floor(Math.random() * TETRIS_PIECES.length);
      tetrisCurrentPiece = {
        shape: TETRIS_PIECES[pieceIndex],
        color: TETRIS_COLORS[pieceIndex],
        x: Math.floor(TETRIS_COLS / 2) - 1,
        y: 0
      };

      if (checkTetrisCollision(tetrisCurrentPiece.x, tetrisCurrentPiece.y, tetrisCurrentPiece.shape)) {
        gameOver('Tetris');
      }
    }

    function moveTetrisPiece(dx, dy) {
      const newX = tetrisCurrentPiece.x + dx;
      const newY = tetrisCurrentPiece.y + dy;

      if (!checkTetrisCollision(newX, newY, tetrisCurrentPiece.shape)) {
        tetrisCurrentPiece.x = newX;
        tetrisCurrentPiece.y = newY;
        drawTetris();
        return true;
      }
      return false;
    }

    function rotateTetrisPiece() {
      const rotated = tetrisCurrentPiece.shape[0].map((_, i) =>
        tetrisCurrentPiece.shape.map(row => row[i]).reverse()
      );

      if (!checkTetrisCollision(tetrisCurrentPiece.x, tetrisCurrentPiece.y, rotated)) {
        tetrisCurrentPiece.shape = rotated;
        drawTetris();
      }
    }

    function checkTetrisCollision(x, y, shape) {
      for (let row = 0; row < shape.length; row++) {
        for (let col = 0; col < shape[row].length; col++) {
          if (shape[row][col]) {
            const newX = x + col;
            const newY = y + row;

            if (newX < 0 || newX >= TETRIS_COLS || newY >= TETRIS_ROWS) {
              return true;
            }

            if (newY >= 0 && tetrisBoard[newY][newX]) {
              return true;
            }
          }
        }
      }
      return false;
    }

    function updateTetris() {
      if (!moveTetrisPiece(0, 1)) {
        mergeTetrisPiece();
        clearTetrisLines();
        spawnTetrisPiece();
      }
      drawTetris();
    }

    function mergeTetrisPiece() {
      for (let row = 0; row < tetrisCurrentPiece.shape.length; row++) {
        for (let col = 0; col < tetrisCurrentPiece.shape[row].length; col++) {
          if (tetrisCurrentPiece.shape[row][col]) {
            const y = tetrisCurrentPiece.y + row;
            const x = tetrisCurrentPiece.x + col;
            if (y >= 0) {
              tetrisBoard[y][x] = tetrisCurrentPiece.color;
            }
          }
        }
      }
    }

    function clearTetrisLines() {
      let linesCleared = 0;
      for (let row = TETRIS_ROWS - 1; row >= 0; row--) {
        if (tetrisBoard[row].every(cell => cell !== 0)) {
          tetrisBoard.splice(row, 1);
          tetrisBoard.unshift(Array(TETRIS_COLS).fill(0));
          linesCleared++;
          row++;
        }
      }

      if (linesCleared > 0) {
        tetrisScore += linesCleared * 100;
        document.getElementById('gameScore').textContent = 'Score: ' + tetrisScore;
      }
    }

    function drawTetris() {
      // Clear canvas
      tetrisCtx.fillStyle = '#fff';
      tetrisCtx.fillRect(0, 0, tetrisCanvas.width, tetrisCanvas.height);

      // Draw board
      for (let row = 0; row < TETRIS_ROWS; row++) {
        for (let col = 0; col < TETRIS_COLS; col++) {
          if (tetrisBoard[row][col]) {
            tetrisCtx.fillStyle = tetrisBoard[row][col];
            tetrisCtx.fillRect(col * BLOCK_SIZE, row * BLOCK_SIZE, BLOCK_SIZE - 1, BLOCK_SIZE - 1);
          }
        }
      }

      // Draw current piece
      tetrisCtx.fillStyle = tetrisCurrentPiece.color;
      for (let row = 0; row < tetrisCurrentPiece.shape.length; row++) {
        for (let col = 0; col < tetrisCurrentPiece.shape[row].length; col++) {
          if (tetrisCurrentPiece.shape[row][col]) {
            tetrisCtx.fillRect(
              (tetrisCurrentPiece.x + col) * BLOCK_SIZE,
              (tetrisCurrentPiece.y + row) * BLOCK_SIZE,
              BLOCK_SIZE - 1,
              BLOCK_SIZE - 1
            );
          }
        }
      }

      // Draw grid
      tetrisCtx.strokeStyle = '#e0e0e0';
      tetrisCtx.lineWidth = 0.5;
      for (let i = 0; i <= TETRIS_COLS; i++) {
        tetrisCtx.beginPath();
        tetrisCtx.moveTo(i * BLOCK_SIZE, 0);
        tetrisCtx.lineTo(i * BLOCK_SIZE, TETRIS_ROWS * BLOCK_SIZE);
        tetrisCtx.stroke();
      }
      for (let i = 0; i <= TETRIS_ROWS; i++) {
        tetrisCtx.beginPath();
        tetrisCtx.moveTo(0, i * BLOCK_SIZE);
        tetrisCtx.lineTo(TETRIS_COLS * BLOCK_SIZE, i * BLOCK_SIZE);
        tetrisCtx.stroke();
      }
    }

    function gameOver(gameName) {
      stopCurrentGame();
      const score = gameName === 'Snake' ? snakeScore : tetrisScore;
      alert('Game Over! ' + gameName + ' - Final Score: ' + score);
      backToMenu();
    }
  </script>
</body>
</html>